<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ p.nome }} | {{ loja.nome }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        :root { --primary: {{ loja.cor_primaria or '#dc2626' }}; }
        body { font-family: 'Poppins', sans-serif; }
        .text-theme { color: var(--primary); }
        .bg-theme { background-color: var(--primary); }
        .border-theme { border-color: var(--primary); }
        .ring-theme { --tw-ring-color: var(--primary); }
        .hover\:bg-theme:hover { background-color: var(--primary); }
        .category-dropdown:hover .dropdown-menu { display: block; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        /* Estilo da Descrição HTML */
        .prose p { margin-bottom: 1em; color: #4b5563; }
        .prose strong { color: #111827; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
    </style>
</head>
<body class="bg-white text-gray-800 flex flex-col min-h-screen">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <a href="/presentes/" class="flex items-center gap-2">
                    {% if loja.logo %}
                    <img src="{{ directus_url }}/assets/{{ loja.logo }}" class="h-10 object-contain">
                    {% else %}
                    <span class="text-xl font-bold text-theme">{{ loja.nome }}</span>
                    {% endif %}
                </a>
                <div class="hidden md:block relative category-dropdown cursor-pointer py-2">
                    <div class="flex items-center gap-1 text-sm font-bold uppercase tracking-wider hover:text-theme">
                        Categorias <i data-lucide="chevron-down" class="w-3 h-3"></i>
                    </div>
                    <div class="dropdown-menu hidden absolute top-full left-0 w-56 bg-white shadow-xl border border-gray-100 z-50 rounded-b-lg">
                        <ul class="py-2 text-sm text-gray-600">
                            {% for cat in categorias %}
                            <li class="px-5 py-2 hover:bg-gray-50 hover:text-theme transition-colors">
                                <a href="/presentes/?categoria={{ cat.id }}">{{ cat.nome }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleCart()" class="relative p-2 hover:bg-gray-100 rounded-full transition-colors group">
                    <i data-lucide="shopping-bag" class="w-6 h-6 text-gray-700 group-hover:text-theme"></i>
                    <span id="cart-count" class="absolute top-0 right-0 bg-theme text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="bg-gray-50 border-b border-gray-200 py-3">
        <div class="container mx-auto px-4 text-xs text-gray-500 uppercase tracking-widest flex items-center gap-2">
            <a href="/presentes/" class="hover:text-theme">Início</a> <i data-lucide="chevron-right" class="w-3 h-3"></i>
            <span>{{ p.nome }}</span>
        </div>
    </div>

    <section class="py-12 container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            
            <div class="space-y-4">
                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-100 relative">
                    <img id="main-image" src="{{ p.galeria[0] }}" class="w-full h-full object-cover transition-opacity duration-300">
                </div>
                <div class="flex gap-4 overflow-x-auto pb-2">
                    {% for img in p.galeria %}
                    <button onclick="changeImage('{{ img }}')" class="w-20 h-20 rounded border-2 border-transparent hover:border-theme focus:border-theme overflow-hidden flex-shrink-0">
                        <img src="{{ img }}" class="w-full h-full object-cover">
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2 leading-tight">{{ p.nome }}</h1>
                <div class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Ref: {{ p.id[:8] }}</div>

                <div class="mb-6">
                    {% if p.preco %}
                    <span class="text-4xl font-bold text-theme">R$ {{ "%.2f"|format(p.preco)|replace('.', ',') }}</span>
                    <span class="text-sm text-gray-500 block mt-1">em até 12x no cartão ou Pix</span>
                    {% else %}
                    <span class="text-2xl font-bold text-gray-400 uppercase">Preço sob consulta</span>
                    {% endif %}
                </div>

                {% if p.variantes and p.variantes|length > 0 %}
                <div class="mb-8">
                    <label class="text-sm font-bold text-gray-900 uppercase tracking-wide block mb-3">
                        Escolha a Cor: <span id="color-label" class="text-theme font-normal">Padrão</span>
                    </label>
                    <div class="flex flex-wrap gap-3">
                        {% for v in p.variantes %}
                        <button onclick="selectVariant('{{ v.nome }}', '{{ v.foto }}')" 
                                class="w-10 h-10 rounded-full border-2 border-gray-200 hover:border-theme focus:ring-2 ring-theme ring-offset-2 bg-cover bg-center transition-all"
                                style="background-image: url('{{ v.foto }}');"
                                title="{{ v.nome }}">
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="flex gap-4 mb-8">
                    <button onclick='addToCartPage({{ p | tojson }})' class="flex-1 bg-gray-900 hover:bg-theme text-white font-bold py-4 rounded-xl text-sm uppercase tracking-widest transition-colors shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                        <span id="btn-add-text">Adicionar à Sacola</span>
                    </button>
                    <a href="https://wa.me/{{ loja.whatsapp }}?text=Tenho%20dúvida%20sobre:%20{{ p.nome }}" target="_blank" class="px-4 py-4 border border-gray-300 rounded-xl hover:bg-gray-50 text-gray-600 transition-colors">
                        <i data-lucide="message-circle" class="w-6 h-6"></i>
                    </a>
                </div>

                <div class="border-t border-gray-100 pt-8">
                    <h3 class="font-bold text-lg mb-4">Descrição do Produto</h3>
                    <div class="prose text-sm text-gray-600 leading-relaxed">
                        {{ p.descricao | safe }}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-gray-50 py-12 border-t mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm text-gray-400">© 2026 {{ loja.nome }}.</p>
            <div class="flex justify-center gap-4 mt-4">
                <a href="/presentes/" class="text-xs font-bold uppercase text-gray-400 hover:text-theme">Voltar para Loja</a>
            </div>
        </div>
    </footer>

    <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay transition-opacity duration-300" onclick="toggleCart()"></div>
        <div class="absolute right-0 top-0 h-full w-full md:w-[450px] bg-white shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-lg flex items-center gap-2 text-gray-800"><i data-lucide="shopping-cart" class="w-5 h-5 text-theme"></i> Sua Sacola</h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6" id="cart-items"></div>
            <div class="p-6 border-t bg-gray-50 space-y-4">
                <div class="bg-white p-4 rounded border border-gray-200">
                    <label class="text-[10px] font-bold uppercase text-gray-400 mb-2 block">Simular Frete</label>
                    <div class="flex gap-2 mb-2"><input type="text" id="cep-input" placeholder="00000-000" class="w-full border rounded p-2 text-sm uppercase" maxlength="9"><button onclick="calcularFrete()" class="bg-gray-800 text-white px-4 rounded text-xs font-bold">OK</button></div>
                    <div id="frete-options" class="space-y-1 text-sm"></div>
                </div>
                <div class="flex justify-between items-center text-xl font-bold pt-2 border-t"><span class="text-gray-600">Total:</span><span id="cart-total" class="text-theme">R$ 0,00</span></div>
                <button onclick="finalizarNoZap()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 animate-pulse"><i data-lucide="message-circle" class="w-5 h-5"></i> FECHAR NO ZAP</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let selectedColor = null;
        let selectedPhoto = "{{ p.galeria[0] }}";
        
        // --- GALERIA ---
        function changeImage(src) {
            document.getElementById('main-image').src = src;
        }

        function selectVariant(name, photo) {
            selectedColor = name;
            selectedPhoto = photo;
            document.getElementById('color-label').innerText = name;
            changeImage(photo);
        }

        // --- CARRINHO (Lógica Global Simplificada) ---
        let cart = JSON.parse(localStorage.getItem('cart_v2') || '[]'); // Persistência simples
        const lojaPhone = "{{ loja.whatsapp }}";

        function saveCart() { localStorage.setItem('cart_v2', JSON.stringify(cart)); updateCartUI(); }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10);
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const countEl = document.getElementById('cart-count');
            const totalQtd = cart.reduce((acc, i) => acc + i.qtd, 0);
            countEl.innerText = totalQtd;
            countEl.classList.toggle('hidden', totalQtd === 0);
            container.innerHTML = '';
            let total = 0;
            cart.forEach((item, i) => {
                total += (item.preco || 0) * item.qtd;
                container.innerHTML += `
                    <div class="flex gap-4 border-b border-gray-100 pb-4">
                        <img src="${item.imagem}" class="w-16 h-16 object-cover rounded-md bg-gray-100">
                        <div class="flex-1">
                            <h4 class="font-bold text-xs text-gray-800">${item.nome_exibicao}</h4>
                            <div class="flex justify-between mt-1">
                                <span class="text-theme font-bold text-sm">R$ ${(item.preco*item.qtd).toFixed(2).replace('.',',')}</span>
                                <div class="flex gap-2 text-xs"><span class="font-bold">x${item.qtd}</span> <button onclick="removeFromCart(${i})" class="text-red-500">Excluir</button></div>
                            </div>
                        </div>
                    </div>`;
            });
            totalEl.innerText = "R$ " + total.toFixed(2).replace('.', ',');
        }

        function removeFromCart(idx) { cart.splice(idx, 1); saveCart(); }

        function addToCartPage(product) {
            let final = { ...product };
            if (selectedColor) {
                final.nome_exibicao = `${product.nome} (${selectedColor})`;
                final.imagem = selectedPhoto;
                final.cart_id = `${product.id}-${selectedColor}`;
            } else {
                final.nome_exibicao = product.nome;
                final.imagem = product.galeria[0];
                final.cart_id = `${product.id}-padrao`;
            }

            const idx = cart.findIndex(i => i.cart_id === final.cart_id);
            if (idx > -1) cart[idx].qtd++; else { final.qtd = 1; cart.push(final); }
            
            saveCart();
            toggleCart();
            
            const btn = document.getElementById('btn-add-text');
            const old = btn.innerText;
            btn.innerText = "Adicionado!";
            setTimeout(() => btn.innerText = old, 2000);
        }

        // Frete e Zap (Cópia simplificada)
        let freteSelecionado = null;
        async function calcularFrete() {
            const cep = document.getElementById('cep-input').value.replace(/\D/g,'');
            const div = document.getElementById('frete-options');
            if(cep.length!==8) return alert('CEP Inválido');
            div.innerHTML = 'Calculando...';
            try {
                // ROTA AXIOS CORRIGIDA COM /presentes/
                const res = await axios.post('/presentes/api/calcular-frete', { cep, itens: cart });
                let html = '';
                res.data.forEach(opt => html += `<label class="flex justify-between p-2 border mb-1 cursor-pointer hover:bg-gray-50"><div class="flex gap-2"><input type="radio" name="frete" onchange="freteSelecionado={nome:'${opt.transportadora}',valor:${opt.preco}}"><div class="text-xs"><b>${opt.transportadora}</b><br>${opt.prazo} dias</div></div><b>R$ ${opt.preco.toFixed(2)}</b></label>`);
                div.innerHTML = html || 'Sem opções.';
            } catch { div.innerHTML = 'Erro.'; }
        }

        function finalizarNoZap() {
            if(cart.length===0) return;
            let msg = "Novo Pedido:\n";
            let total = 0;
            cart.forEach(i => { msg+=`— ${i.qtd}x ${i.nome_exibicao}\n`; total+=i.preco*i.qtd; });
            msg += `Total: R$ ${total.toFixed(2)}\n`;
            if(freteSelecionado) msg += `Frete: ${freteSelecionado.nome} (R$ ${freteSelecionado.valor.toFixed(2)})`;
            window.open(`https://wa.me/${lojaPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Init
        updateCartUI();
    </script>
</body>
</html>